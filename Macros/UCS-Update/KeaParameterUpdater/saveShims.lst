Freescale Semiconductor DSP56300 Assembler  Version 6.3.28   21-10-08  17:25:57  saveShims.asm  Page 1



1                          ;**************************************************************************
2                          ;   saveShims.asm - routine to store the last shim and calibration data
3                          ;                    in flash eeprom
4                          ;
5                          ;   October 2021 update : version 1.2 for DSP56321 and ATMEL AT29LV020
6                          ;                         based on config4 by Raschid and Robin
7                          ;   Craig Eccles
8                          ;
9                          ;   This routine loads the first 80 words stored at the base of Y memory
10                         ;   into the flash memory at address is P:D3F000
11                         ;
12                         ;**************************************************************************
616    
617       P:002000                   org     p:$002000
618    
619       P:002000 605E00            move              r0,x:(r6)+              ;Save registers
620       P:002001 615E00            move              r1,x:(r6)+
621       P:002002 625E00            move              r2,x:(r6)+
622       P:002003 445E00            move              x0,x:(r6)+
623       P:002004 505E00            move              a0,x:(r6)+
624       P:002005 545E00            move              a1,x:(r6)+
625       P:002006 525E00            move              a2,x:(r6)+
626       P:002007 515E00            move              b0,x:(r6)+
627       P:002008 555E00            move              b1,x:(r6)+
628       P:002009 535E00            move              b2,x:(r6)+
629       P:00200A 62F400            move              #$D3F000,r2             ; config at flash address $D3F000
                   D3F000
630       P:00200C 300000            move              #0,r0                   ; start of program mem
631       P:00200D 05080C            bsr     <WRY_FLASH                        ; WRY_FLASH loads 84 words each time
632       P:00200E 53FE00            move              x:-(r6),b2              ; Restore registers
633       P:00200F 55FE00            move              x:-(r6),b1
634       P:002010 51FE00            move              x:-(r6),b0
635       P:002011 52FE00            move              x:-(r6),a2
636       P:002012 54FE00            move              x:-(r6),a1
637       P:002013 50FE00            move              x:-(r6),a0
638       P:002014 44FE00            move              x:-(r6),x0
639       P:002015 62FE00            move              x:-(r6),r2
640       P:002016 61FE00            move              x:-(r6),r1
641       P:002017 60FE00            move              x:-(r6),r0
642       P:002018 00000C            rts
643    
644    
645                        ;************************************************************************
646                        ;   WRY_FLASH
647                        ;   This routine writes one 256-byte FLASH sector.
648                        ;   Each sector will contain 84 (24-bit) words from DSP RAM (252 bytes)
649                        ;   The last 4 bytes contain a 16-bit checksum of the data
650                        ;   followed by two blank bytes.
651                        ;
652                        ;   enter with:  r2 pointing to starting PEROM Byte Address from 56309 p.o.v.
653                        ;                r0 pointing to first DSP word to save
Freescale Semiconductor DSP56300 Assembler  Version 6.3.28   21-10-08  17:25:57  saveShims.asm  Page 2



654                        ;
655                        ;   corrupts:    r0 - points to next Y:memory location to save
656                        ;                r2 - points to next P:FLASH byte address to write
657                        ;                a,b,x0
658                        ;-----------------------------------------------------------------------------
659    
660                        WRY_FLASH
661       P:002019 20001B            clr     b                                 ;initialize checksum
662                        ;----------------------------------------------------------------------------
663                        ;  disable_protect - Software data Protection routine
664                        ;  Note: upper address lines swapped
665                        ;----------------------------------------------------------------------------
666    
667       P:00201A 44F400            move              #>$AA,x0                ;Atmel needs $AA
                   0000AA
668       P:00201C 077084            move              x0,p:$D09555            ;at address $5555
                   D09555
669       P:00201E 44F400            move              #>$55,x0                ;then $55
                   000055
670       P:002020 077084            move              x0,p:$D068AA            ;at address $2AAA
                   D068AA
671       P:002022 44F400            move              #>$A0,x0                ;then $A0
                   0000A0
672       P:002024 077084            move              x0,p:$D09555            ;at address $5555
                   D09555
673                                                                            ;--- writes are now enabled
674    
675       P:002026 065490            dor     #84,move_ycode                    ;move 252 bytes
                   000008
676       P:002028 5ED800            move                          y:(r0)+,a   ;get 3 byte word
677       P:002029 200018            add     a,b                               ;accumulate checksum
678       P:00202A 075A8C            move              a1,p:(r2)+              ;move low byte to flash
679       P:00202B 0C1ED0            lsr     #8,a
**** 680 [saveShims.asm 80]: WARNING --- Pipeline stall reading register written in previous instruction (X data move field)
680       P:00202C 075A8C            move              a1,p:(r2)+              ;move mid byte
681       P:00202D 0C1ED0            lsr     #8,a
**** 682 [saveShims.asm 82]: WARNING --- Pipeline stall reading register written in previous instruction (X data move field)
682       P:00202E 075A8C            move              a1,p:(r2)+              ;move high byte
683                        move_ycode
684    
685                                                                            ;*** 253rd and 254th bytes are 16-bit checksum
686       P:00202F 075A8D            move              b1,p:(r2)+              ;move low byte of checksum to flash
687       P:002030 0C1ED1            lsr     #8,b                              ;get next 8 bits of checksum
**** 688 [saveShims.asm 88]: WARNING --- Pipeline stall reading register written in previous instruction (X data move field)
688       P:002031 075A8D            move              b1,p:(r2)+              ;move mid byte of checksum to flash
689       P:002032 20001B            clr     b                                 ;The last two bytes are 0
**** 690 [saveShims.asm 90]: WARNING --- Pipeline stall reading register B written in previous instruction (X data move field)
**** 690 [saveShims.asm 90]: WARNING --- Pipeline stall reading register written in previous instruction (X data move field)
690       P:002033 075A8D            move              b1,p:(r2)+              ;to make up 256.
691       P:002034 075A8D            move              b1,p:(r2)+
692       P:002035 050802            bsr     <delay_20m                        ;wait 20 milliseconds to finish
Freescale Semiconductor DSP56300 Assembler  Version 6.3.28   21-10-08  17:25:57  saveShims.asm  Page 3



693                                                                            ;...program cycle
694       P:002036 00000C            rts
695    
696                        ;---------------------------------------------------------------------------
697                        ; delay_20m --
698                        ; 20.15 ms of delay guarantees that the write cycle has finished.
699                        ;
700                        ; For Write Pulse Width High to extend 150 us requires a minimum of
701                        ; 5100 Icycles for a 33.868 MHz clock.  (29.5 ns/Icycle)
702                        ;
703                        ; the tWC is 20ms, so we just wait long enough here for the
704                        ; write cycle to have started AND finished...
705                        ;
706                        ;---------------------------------------------------------------------------
707                        delay_20m
708       P:002037 06D290            dor     #210,_l1                          ;110 x 207us = 22.7 ms
                   000006
709       P:002039 44F400            move              #7000,x0
                   001B58
710       P:00203B 06C420            rep     x0                                ; 207us delay
711       P:00203C 000000            nop
712       P:00203D 000000            nop
713                        _l1
714       P:00203E 00000C            rts
715    
716                                  end

0    Errors
5    Warnings


