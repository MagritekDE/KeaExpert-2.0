Freescale Semiconductor DSP56300 Assembler  Version 6.3.28   20-06-16  17:29:17  config234.asm  Page 1



1                          ;**************************************************************************
2                          ;   config.asm - routine to store spectrometer configuration data in flash eeprom
3                          ;
4                          ;   February 2010 : version 1.0 For 56309 and ATMEL AT29LV020
5                          ;       original Version
6                          ;   Robin Dykstra
7                          ;
8                          ;       June 2020 update : version 1.1 for DSP56321 and ATMEL AT29LV020
9                          ;       Raschid Tamrzadeh
10                         ;
11                         ;   This routine loads the first 80 words stored at the base of Y memory
12                         ;   into the top sector of the flash memory which is P:D3FF00
13                         ;       NEW: and the next three sets of 80 words from Y memory to the addresses P:D3FC00
14                         ;
15                         ;**************************************************************************
619    
620       P:002000                   org     p:$002000
621    
622       P:002000 605E00            move              r0,x:(r6)+              ;Save registers
623       P:002001 615E00            move              r1,x:(r6)+
624       P:002002 625E00            move              r2,x:(r6)+
625       P:002003 445E00            move              x0,x:(r6)+
626       P:002004 505E00            move              a0,x:(r6)+
627       P:002005 545E00            move              a1,x:(r6)+
628       P:002006 525E00            move              a2,x:(r6)+
629       P:002007 515E00            move              b0,x:(r6)+
630       P:002008 555E00            move              b1,x:(r6)+
631       P:002009 535E00            move              b2,x:(r6)+
632                                                                            ;    move    #$D3FF00,r2        ; config at flash add
ress $D3FF00
633                                                                            ;    move    #0,r0              ; start of program me
m
634                                                                            ;    bsr     <WRY_FLASH         ; WRY_FLASH loads 84 
words each time
635       P:00200A 62F400            move              #$D3FC00,r2             ; config at flash address $D3FF00
                   D3FC00
636       P:00200C 305500            move              #85,r0                  ; start of program mem
637       P:00200D 050814            bsr     <WRY_FLASH                        ; WRY_FLASH loads 84 words each time
638       P:00200E 62F400            move              #$D3FD00,r2             ; config at flash address $D3FF00
                   D3FD00
639       P:002010 30AA00            move              #170,r0                 ; start of program mem
640       P:002011 050810            bsr     <WRY_FLASH                        ; WRY_FLASH loads 84 words each time
641       P:002012 62F400            move              #$D3FE00,r2             ; config at flash address $D3FF00
                   D3FE00
642       P:002014 30FF00            move              #255,r0                 ; start of program mem
643       P:002015 05080C            bsr     <WRY_FLASH                        ; WRY_FLASH loads 84 words each time
644       P:002016 53FE00            move              x:-(r6),b2              ; Restore registers
645       P:002017 55FE00            move              x:-(r6),b1
646       P:002018 51FE00            move              x:-(r6),b0
647       P:002019 52FE00            move              x:-(r6),a2
648       P:00201A 54FE00            move              x:-(r6),a1
Freescale Semiconductor DSP56300 Assembler  Version 6.3.28   20-06-16  17:29:17  config234.asm  Page 2



649       P:00201B 50FE00            move              x:-(r6),a0
650       P:00201C 44FE00            move              x:-(r6),x0
651       P:00201D 62FE00            move              x:-(r6),r2
652       P:00201E 61FE00            move              x:-(r6),r1
653       P:00201F 60FE00            move              x:-(r6),r0
654       P:002020 00000C            rts
655    
656    
657                        ;************************************************************************
658                        ;   WRY_FLASH
659                        ;   This routine writes one 256-byte FLASH sector.
660                        ;   Each sector will contain 84 (24-bit) words from DSP RAM (252 bytes)
661                        ;   The last 4 bytes contain a 16-bit checksum of the data
662                        ;   followed by two blank bytes.
663                        ;
664                        ;   enter with:  r2 pointing to starting PEROM Byte Address from 56309 p.o.v.
665                        ;                r0 pointing to first DSP word to save
666                        ;
667                        ;   corrupts:    r0 - points to next Y:memory location to save
668                        ;                r2 - points to next P:FLASH byte address to write
669                        ;                a,b,x0
670                        ;-----------------------------------------------------------------------------
671    
672                        WRY_FLASH
673       P:002021 20001B            clr     b                                 ;initialize checksum
674                        ;----------------------------------------------------------------------------
675                        ;  disable_protect - Software data Protection routine
676                        ;  Note: upper address lines swapped
677                        ;----------------------------------------------------------------------------
678    
679       P:002022 44F400            move              #>$AA,x0                ;Atmel needs $AA
                   0000AA
680       P:002024 077084            move              x0,p:$D09555            ;at address $5555
                   D09555
681       P:002026 44F400            move              #>$55,x0                ;then $55
                   000055
682       P:002028 077084            move              x0,p:$D068AA            ;at address $2AAA
                   D068AA
683       P:00202A 44F400            move              #>$A0,x0                ;then $A0
                   0000A0
684       P:00202C 077084            move              x0,p:$D09555            ;at address $5555
                   D09555
685                                                                            ;--- writes are now enabled
686    
687       P:00202E 065490            dor     #84,move_ycode                    ;move 252 bytes
                   000008
688       P:002030 5ED800            move                          y:(r0)+,a   ;get 3 byte word
689       P:002031 200018            add     a,b                               ;accumulate checksum
690       P:002032 075A8C            move              a1,p:(r2)+              ;move low byte to flash
691       P:002033 0C1ED0            lsr     #8,a
**** 692 [config234.asm 92]: WARNING --- Pipeline stall reading register written in previous instruction (X data move field)
Freescale Semiconductor DSP56300 Assembler  Version 6.3.28   20-06-16  17:29:17  config234.asm  Page 3



692       P:002034 075A8C            move              a1,p:(r2)+              ;move mid byte
693       P:002035 0C1ED0            lsr     #8,a
**** 694 [config234.asm 94]: WARNING --- Pipeline stall reading register written in previous instruction (X data move field)
694       P:002036 075A8C            move              a1,p:(r2)+              ;move high byte
695                        move_ycode
696    
697                                                                            ;*** 253rd and 254th bytes are 16-bit checksum
698       P:002037 075A8D            move              b1,p:(r2)+              ;move low byte of checksum to flash
699       P:002038 0C1ED1            lsr     #8,b                              ;get next 8 bits of checksum
**** 700 [config234.asm 100]: WARNING --- Pipeline stall reading register written in previous instruction (X data move field)
700       P:002039 075A8D            move              b1,p:(r2)+              ;move mid byte of checksum to flash
701       P:00203A 20001B            clr     b                                 ;The last two bytes are 0
**** 702 [config234.asm 102]: WARNING --- Pipeline stall reading register B written in previous instruction (X data move field)
**** 702 [config234.asm 102]: WARNING --- Pipeline stall reading register written in previous instruction (X data move field)
702       P:00203B 075A8D            move              b1,p:(r2)+              ;to make up 256.
703       P:00203C 075A8D            move              b1,p:(r2)+
704       P:00203D 050802            bsr     <delay_20m                        ;wait 20 milliseconds to finish
705                                                                            ;...program cycle
706       P:00203E 00000C            rts
707    
708                        ;---------------------------------------------------------------------------
709                        ; delay_20m --
710                        ; 20.15 ms of delay guarantees that the write cycle has finished.
711                        ;
712                        ; For Write Pulse Width High to extend 150 us requires a minimum of
713                        ; 5100 Icycles for a 33.868 MHz clock.  (29.5 ns/Icycle)
714                        ;
715                        ; the tWC is 20ms, so we just wait long enough here for the
716                        ; write cycle to have started AND finished...
717                        ;
718                        ;---------------------------------------------------------------------------
719                        delay_20m
720       P:00203F 06D290            dor     #210,_l1                          ;110 x 207us = 22.7 ms
                   000006
721       P:002041 44F400            move              #7000,x0
                   001B58
722       P:002043 06C420            rep     x0                                ; 207us delay
723       P:002044 000000            nop
724       P:002045 000000            nop
725                        _l1
726       P:002046 00000C            rts
727    
728                                  end

0    Errors
5    Warnings


